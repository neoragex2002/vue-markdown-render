import{_ as s,c as e,o as a,ag as l}from"./chunks/framework.C0wiDQbp.js";const c=JSON.parse('{"title":"Legacy build & compatibility guide (Vite / Webpack)","description":"","frontmatter":{},"headers":[],"relativePath":"guide/legacy-builds.md","filePath":"guide/legacy-builds.md"}'),t={name:"guide/legacy-builds.md"};function n(p,i,d,o,h,r){return a(),e("div",null,[...i[0]||(i[0]=[l(`<h1 id="legacy-build-compatibility-guide-vite-webpack" tabindex="-1">Legacy build &amp; compatibility guide (Vite / Webpack) <a class="header-anchor" href="#legacy-build-compatibility-guide-vite-webpack" aria-label="Permalink to &quot;Legacy build &amp; compatibility guide (Vite / Webpack)&quot;">​</a></h1><p>Purpose</p><ul><li>This document explains how to use legacy builds to improve compatibility with older browsers (for example older iOS / Safari) and when you should instead fix issues in source code.</li></ul><p>Key reminder</p><ul><li>Some problems (notably RegExp engine-level syntax like lookbehind <code>(?&lt;!...)</code>) cannot be fixed by polyfills. Legacy builds transform syntax and inject API polyfills but cannot add RegExp engine features to an older JS runtime. If you encounter such issues, you must either rewrite the code or delay construction/runtime-detect and fallback. See <code>ios-regex-compat.md</code> for details.</li></ul><p>What this page covers</p><ul><li>Vite: <code>@vitejs/plugin-legacy</code> usage and caveats</li><li>Webpack: common two-build (modern + legacy) approaches</li><li>Managing polyfills (<code>core-js</code>, <code>regenerator-runtime</code>) and targets</li><li>Testing, CI and quick debug checklist</li></ul><p>Vite (recommended if your project uses Vite)</p><p>Install:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @vitejs/plugin-legacy</span></span></code></pre></div><p>Example <code>vite.config.ts</code>:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> legacy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@vitejs/plugin-legacy&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    legacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      targets: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;defaults&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iOS &gt;= 11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      additionalLegacyPolyfills: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;regenerator-runtime/runtime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      renderLegacyChunks: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p>Notes</p><ul><li><code>targets</code> controls which transforms/polyfills are applied. Set to your minimum supported browsers.</li><li><code>additionalLegacyPolyfills</code> injects runtime libraries into the legacy bundle.</li><li><code>renderLegacyChunks</code> enables differential chunks served via <code>type=&quot;module&quot;</code> / <code>nomodule</code>.</li><li>Important: plugin-legacy cannot rewrite engine-level RegExp syntax (lookbehind). Keep incompatible regex out of literal module scope or rewrite them.</li></ul><p>Webpack</p><p>Webpack does not provide a single plugin equivalent to Vite&#39;s plugin-legacy. Common approach: build two bundles with Babel (modern + legacy) and serve them with <code>type=&quot;module&quot;</code> / <code>nomodule</code>.</p><p>Key deps:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @babel/core</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> babel-loader</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @babel/preset-env</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> core-js</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> regenerator-runtime</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> webpack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> webpack-cli</span></span></code></pre></div><p>Example approach</p><ul><li>Create a <code>babel.config.js</code> that supports <code>BABEL_ENV=legacy</code> to enable <code>useBuiltIns: &#39;usage&#39;</code> and a legacy <code>targets</code> set. Run two webpack builds: one modern, one legacy. Serve modern bundle with <code>&lt;script type=&quot;module&quot;&gt;</code> and legacy with <code>&lt;script nomodule&gt;</code>.</li></ul><p>Polyfills</p><ul><li>Use <code>core-js</code> for standard API polyfills (v3). For generators/async: <code>regenerator-runtime/runtime</code>.</li><li>Prefer differential serving so modern bundles stay small.</li></ul><p>RegExp and engine-level syntax</p><ul><li>RegExp features such as lookbehind are implemented by the JS engine. Polyfills cannot add them. Either <ul><li>rewrite the regex to a compatible form, or</li><li>delay regex construction (use <code>new RegExp(...)</code>) and use runtime feature-detection + fallback.</li></ul></li></ul><p>Testing &amp; CI</p><ul><li>Add <code>pnpm run build</code> (modern + legacy) in CI and run smoke tests on older browsers (BrowserStack / SauceLabs or Xcode simulator).</li><li>Add a static check to block new lookbehind/unicode-regex features (see examples below).</li></ul><p>Quick local checks</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Static scan for advanced regex in source</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dlx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">?&lt;!|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">?&lt;=|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --glob</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;**/*.{js,ts,vue,jsx,tsx,mjs,cjs}&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span></span></code></pre></div><p>Summary</p><ul><li>Legacy builds are useful for many syntax &amp; API gaps, but they are not a replacement for fixing engine-level RegExp syntax in source. Prefer: source fix -&gt; legacy bundle -&gt; CI + old-device smoke tests.</li></ul><p>Quick test — run a local legacy build (Vite + plugin-legacy):</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># verify modern + legacy bundles output and test on an older device or simulator</span></span></code></pre></div>`,32)])])}const g=s(t,[["render",n]]);export{c as __pageData,g as default};
