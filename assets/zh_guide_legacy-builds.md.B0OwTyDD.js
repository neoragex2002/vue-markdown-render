import{_ as i,c as a,o as l,ag as e}from"./chunks/framework.C0wiDQbp.js";const o=JSON.parse('{"title":"Legacy 构建与兼容性指南（Vite / Webpack）","description":"","frontmatter":{},"headers":[],"relativePath":"zh/guide/legacy-builds.md","filePath":"zh/guide/legacy-builds.md"}'),n={name:"zh/guide/legacy-builds.md"};function t(p,s,h,k,d,c){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="legacy-构建与兼容性指南-vite-webpack" tabindex="-1">Legacy 构建与兼容性指南（Vite / Webpack） <a class="header-anchor" href="#legacy-构建与兼容性指南-vite-webpack" aria-label="Permalink to &quot;Legacy 构建与兼容性指南（Vite / Webpack）&quot;">​</a></h1><p>目的</p><ul><li>本文档说明如何使用 legacy 构建以增强旧浏览器（例如较低版本 iOS / Safari）的兼容性，以及何时应该在源码层修复问题。</li></ul><p>重要提醒</p><ul><li>部分问题（尤其是正则引擎级语法，如 lookbehind <code>(?&lt;!...)</code>）无法通过 polyfill 修复。legacy 构建可以转换语法和注入 API polyfill，但不能向旧的 JS 运行时“增加”正则引擎特性。如果遇到这类问题，必须在源码层重写或延迟构造并运行时检测/回退。详见 <code>ios-regex-compat</code> 文档。</li></ul><p>Vite（推荐）</p><p>安装：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @vitejs/plugin-legacy</span></span></code></pre></div><p>示例配置（<code>vite.config.ts</code>）：</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> legacy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@vitejs/plugin-legacy&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    legacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      targets: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;defaults&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iOS &gt;= 11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      additionalLegacyPolyfills: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;regenerator-runtime/runtime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      renderLegacyChunks: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p>注意：</p><ul><li><code>targets</code> 决定哪些语法/Polyfill 需要应用。根据需要支持的最低版本设置。</li><li><code>additionalLegacyPolyfills</code> 可以把运行时库注入到 legacy bundle。</li><li><code>renderLegacyChunks</code> 生成按需加载的 legacy chunk，并配合 <code>type=&quot;module&quot;</code> / <code>nomodule</code> 差异化加载。</li><li>但 plugin-legacy 无法改写正则 lookbehind 等引擎级语法；此类问题仍需在源码层处理。</li></ul><p>Webpack</p><p>常见做法是用 Babel 做两套构建（modern + legacy），通过 <code>type=&quot;module&quot;</code> / <code>nomodule</code> 差异化服务。示例依赖与 <code>babel.config.js</code> 请参考英文文档上半部分。</p><p>Polyfills</p><ul><li>使用 <code>core-js</code>（v3）和 Babel 的 <code>useBuiltIns: &#39;usage&#39;</code>，并仅在 legacy 构建中注入需要的 polyfill。</li></ul><p>正则语法特殊说明</p><ul><li>引擎级正则语法必须在源码层处理：改写或运行时延迟构造并做 feature-detect。</li></ul><p>测试与 CI</p><ul><li>在 CI 中运行 modern + legacy 构建，并在旧设备/模拟器上做 smoke tests。可加入静态检查阻止新提交引入高级正则写法。</li></ul><p>快速检查（本地）</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dlx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">?&lt;!|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">?&lt;=|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --glob</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;**/*.{js,ts,vue,jsx,tsx,mjs,cjs}&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span></span></code></pre></div><p>总结</p><ul><li>优先在源码层修复不兼容的正则语法；使用 legacy 构建来覆盖语法与 API 差异，并在 CI/QA 中验证旧设备表现。</li></ul>`,24)])])}const r=i(n,[["render",t]]);export{o as __pageData,r as default};
